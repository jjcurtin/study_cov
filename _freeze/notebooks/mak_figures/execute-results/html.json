{
  "hash": "5539cd8110677e81e2864e51e06e6096",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Make Figures for Main Manuscript\"\nauthor: \"Lauren Khoury and Kendra Wyant\"\ndate: \"2025-10-23\"\nnumber-sections: true\noutput: \n  html_document:\n    toc: true \n    toc_depth: 4\nformat:\n  html:\n    embed-resources: true\n    toc: true\n    toc-depth: 4\neditor_options: \n  chunk_output_type: console\nexecute:\n  echo: false\nhtml-table-processing: none\n---\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\n#| label: set up\n\nlibrary(dplyr) |> suppressMessages()\nlibrary(skimr)\nlibrary(purrr)\nlibrary(ggplot2)\nlibrary(patchwork)\nlibrary(ggpattern)\nlibrary(forcats)\nlibrary(kableExtra, exclude = (\"group_rows\"))\n\ntheme_set(theme_classic())\nmethod_colors <- c(\"No covariates\" = \"sienna\",\n                   \"All covariates\" = \"goldenrod2\",\n                   \"p-hacking\" = \"#B01505\",\n                   \"Bivariate correlation\" = \"#A1ECFF\",\n                   \"Partial correlation\" = \"#113378\",\n                   \"Full linear model\" = \"#C199F2\",\n                   \"Full linear model with X\" = \"#351178\",\n                   \"LASSO\" = \"#71E36D\",\n                   \"LASSO with X\" = \"#054C02\")\nmethod_linetypes <- c(\"No covariates\" = \"solid\",\n                      \"All covariates\" = \"solid\",\n                      \"p-hacking\" = \"dashed\",\n                      \"Bivariate correlation\" = \"longdash\",\n                      \"Partial correlation\" = \"twodash\",\n                      \"Full linear model\" = \"longdash\",\n                      \"Full linear model with X\" = \"twodash\",\n                      \"LASSO\" = \"longdash\",\n                      \"LASSO with X\" = \"twodash\")\n\n# method_patterns <- c(\"No covariates\" = \"none\",\n#                       \"All covariates\" = \"none\",\n#                       \"p-hacking\" = \"crosshatch\",\n#                       \"Bivariate correlation\" = \"stripe\",\n#                       \"Partial correlation\" = \"circle\",\n#                       \"Full linear model\" = \"stripe\",\n#                       \"Full linear model with X\" = \"circle\",\n#                       \"LASSO\" = \"stripe\",\n#                       \"LASSO with X\" = \"circle\")\n\ndevtools::source_url(\"https://github.com/jjcurtin/lab_support/blob/main/format_path.R?raw=true\") |> suppressMessages()\n\nrdrive_path <- format_path(\"cov/raw_data\")\n\noptions(digits = 3)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\n#| label: read in data\n\nd_0 <- data.table::fread(here::here(rdrive_path, \"batch_results_new_method_0.csv\"))\nd_03 <- data.table::fread(here::here(rdrive_path, \"batch_results_new_method_03.csv\"))\nd_05 <- data.table::fread(here::here(rdrive_path, \"batch_results_new_method_05.csv\"))\n\nd_20_covs <- data.table::fread(here::here(rdrive_path, \"batch_results_20_covs.csv\"))\nd_n50 <- data.table::fread(here::here(rdrive_path, \"batch_results_n50.csv\"))\n\nd2_0 <- data.table::fread(here::here(rdrive_path, \"batch_results_new_20K_0.csv\"))\nd2_03 <- data.table::fread(here::here(rdrive_path, \"batch_results_new_20K_03.csv\"))\nd2_05 <- data.table::fread(here::here(rdrive_path, \"batch_results_new_20K_05.csv\"))\n\nd_wo_x_og <- data.table::fread(here::here(rdrive_path, \"batch_results_methods_wo_x_og_seed.csv\"))\nd_wo_x_new <- data.table::fread(here::here(rdrive_path, \"batch_results_methods_wo_x_new_seed.csv\"))\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\n#| label: combine data\n\nd_0 <- rbind(d_0, d_20_covs |> filter(b_x == 0))\nd_03 <- rbind(d_03, d_20_covs |> filter(b_x == 0.3))\nd_05 <- rbind(d_05, d_20_covs |> filter(b_x == 0.5))\n\nd_0 <- rbind(d_0, d_n50 |> filter(b_x == 0))\nd_03 <- rbind(d_03, d_n50 |> filter(b_x == 0.3))\nd_05 <- rbind(d_05, d_n50 |> filter(b_x == 0.5))\n\nd_0 <- rbind(d_0, d2_0)\nd_03 <- rbind(d_03, d2_03)\nd_05 <- rbind(d_05, d2_05)\n\nd_0 <- rbind(d_0, d_wo_x_og |> filter(b_x == 0))\nd_0 <- rbind(d_0, d_wo_x_new |> filter(b_x == 0))\nd_03 <- rbind(d_03, d_wo_x_og |> filter(b_x == 0.3))\nd_03 <- rbind(d_03, d_wo_x_new |> filter(b_x == 0.3))\nd_05 <- rbind(d_05, d_wo_x_og |> filter(b_x == 0.5))\nd_05 <- rbind(d_05, d_wo_x_new |> filter(b_x == 0.5))\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nrm(d_20_covs, d_n50, d2_0, d2_03, d2_05, d_wo_x_og, d_wo_x_new)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\n#| label: factor levels\n\nd_0 <- d_0 |> \n  mutate(method = factor(method, levels = c(\"no_covs\", \"all_covs\", \"p_hacked\", \"r\", \n                                            \"partial_r\", \"full_lm_wo_x\", \"full_lm\",  \n                                           \"lasso_wo_x\", \"lasso\"),\n                         labels = c(\"No covariates\", \"All covariates\", \"p-hacking\", \n                                    \"Bivariate correlation\", \"Partial correlation\", \n                                    \"Full linear model\", \"Full linear model with X\", \n                                            \"LASSO\", \"LASSO with X\")))\n\nd_03 <- d_03 |> \n  mutate(method = factor(method, levels = c(\"no_covs\", \"all_covs\", \"p_hacked\", \"r\", \n                                            \"partial_r\", \"full_lm_wo_x\", \"full_lm\",  \n                                           \"lasso_wo_x\", \"lasso\"),\n                         labels = c(\"No covariates\", \"All covariates\", \"p-hacking\", \n                                    \"Bivariate correlation\", \"Partial correlation\", \n                                    \"Full linear model\", \"Full linear model with X\", \n                                            \"LASSO\", \"LASSO with X\")))\n\nd_05 <- d_05 |> \n  mutate(method = factor(method, levels = c(\"no_covs\", \"all_covs\", \"p_hacked\", \"r\", \n                                            \"partial_r\", \"full_lm_wo_x\", \"full_lm\",  \n                                           \"lasso_wo_x\", \"lasso\"),\n                         labels = c(\"No covariates\", \"All covariates\", \"p-hacking\", \n                                    \"Bivariate correlation\", \"Partial correlation\", \n                                    \"Full linear model\", \"Full linear model with X\", \n                                            \"LASSO\", \"LASSO with X\")))\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\ntype_I_summary <- d_0 |>\n  group_by(method) |>\n  summarise(type_I = mean(p_value < 0.05))\n```\n:::\n\n::: {#cell-fig-bar-1 .cell}\n\n```{.r .cell-code .hidden}\n#| label: fig-bar-1\n#| fig-cap: \"Type I Error by Method. Average type I error rate across all research settings is displayed for each method separately by color. Dashed line depicts expected Type I error rate for .05 alpha.\"\n\ntype_I_summary |>\n  mutate(method = fct_relevel(method, \"p-hacking\")) |>\n  ggplot(aes(x = method, y = type_I, fill = method)) +\n  geom_col(color = \"black\") +\n  # ggplot(aes(x = method, y = type_I, fill = method, pattern = method)) +\n  # geom_bar_pattern(\n  #   stat = \"identity\",\n  #   pattern_fill = \"black\",\n  #   pattern_angle = 45,\n  #   pattern_density = 0.1,\n  #   pattern_size = .1,\n  #   pattern_spacing = 0.05,\n  #   color = \"black\") +\n  geom_text(aes(label = sprintf(\"%.3f\", type_I)), vjust = -0.5) +\n  geom_hline(yintercept = .5, linetype = \"dashed\") +\n  labs(x = NULL,\n       y = \"Type I Error\") +\n  scale_y_continuous(limits = c(0, max(type_I_summary$type_I) * 1.2), \n                     breaks = seq(0, max(type_I_summary$type_I) * 1.2, by = 0.05)) +\n  # scale_pattern_manual(values = method_patterns) +\n  scale_fill_manual(values = method_colors) +\n  theme(axis.text.x = element_text(angle = 45, hjust = 1),\n        legend.position = \"none\")\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nWarning: Removed 1 row containing missing values or values outside the scale range\n(`geom_hline()`).\n```\n\n\n:::\n\n::: {.cell-output-display}\n![Type I Error by Method. Average type I error rate across all research settings is displayed for each method separately by color. Dashed line depicts expected Type I error rate for .05 alpha.](mak_figures_files/figure-html/fig-bar-1-1.png){#fig-bar-1 width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nobservations <- d_0 |> \n  group_by(method, n_obs) |> \n  summarise(prop_sig = mean(p_value < 0.05),\n            .groups = \"drop\") |> \n  ggplot(aes(x = n_obs, y = prop_sig, color = method, linetype = method)) + \n  geom_line() +\n  scale_x_continuous(breaks = c(50, 100, 150, 200, 300, 400)) +\n  scale_y_continuous(breaks = c(0.05, 0.10, 0.15, 0.20, .25, .30),\n                     limits = c(0.03, .30)) +\n  labs(x = NULL,\n       subtitle = \"Number of Observations\",\n       y = \"Type I Error\") +\n  scale_linetype_manual(values = method_linetypes) +\n  scale_color_manual(values = method_colors) +\n  theme(legend.title = element_blank())\n\n\ncovs <- d_0 |> \n  group_by(method, n_covs) |> \n  summarise(prop_sig = mean(p_value < 0.05),\n            .groups = \"drop\") |> \n  ggplot(aes(x = n_covs, y = prop_sig, color = method, linetype = method)) + \n  geom_line() +\n  scale_x_continuous(breaks = c(4, 8, 12, 16, 20)) +\n  scale_y_continuous(breaks = c(0.05, 0.10, 0.15, 0.20, 0.25, .30),\n                     limits = c(.03, .30)) +\n  labs(y = NULL,\n       x = NULL,\n       subtitle = \"Number of Covariates\") +\n  scale_linetype_manual(values = method_linetypes) +\n  scale_color_manual(values = method_colors) +\n  theme(legend.title = element_blank())\n\ngood_covs <- d_0 |> \n  group_by(method, p_good_covs) |> \n  summarise(prop_sig = mean(p_value < 0.05),\n            .groups = \"drop\") |> \n  ggplot(aes(x = p_good_covs, y = prop_sig, color = method, linetype = method)) + \n  geom_line() +\n  scale_x_continuous(breaks = c(0.25, 0.50, 0.75)) +\n  scale_y_continuous(breaks = c(0.05, 0.10, 0.15, 0.20, .25, .30), \n                     limits = c(.03, .30)) +\n  labs(y = \"Type I Error\",\n       x = NULL,\n       subtitle = \"Proportion of Good Covariates\") +\n  scale_linetype_manual(values = method_linetypes) +\n  scale_color_manual(values = method_colors) +\n  theme(legend.title = element_blank())\n\nycor <- d_0 |> \n  group_by(method, r_ycov) |> \n  summarise(prop_sig = mean(p_value < 0.05),\n            .groups = \"drop\") |> \n  ggplot(aes(x = r_ycov, y = prop_sig, color = method, linetype = method)) + \n  geom_line() +\n  scale_x_continuous(breaks = c(0.3, 0.5)) +\n  scale_y_continuous(breaks = c(0.05, 0.10, 0.15, 0.20, 0.25, 0.30), \n                     limits = c(.03, .30)) +\n  labs(y = NULL,\n       x = NULL,\n       subtitle = \"Y-Covariate Correlation Strength\") +\n  scale_linetype_manual(values = method_linetypes) +\n  scale_color_manual(values = method_colors) +\n  theme(legend.title = element_blank())\n```\n:::\n\n::: {#cell-fig-type1-panel .cell}\n\n```{.r .cell-code .hidden}\n#| label: fig-type1-panel\n#| fig-cap: \"Type I error by method and research setting. Plots are paneled by aspects of the research setting (number of observations, number of covariates, proportioin of good covariates, and Y-covariate correlation strength). Methods are displayed separately by color. Methods with no covariate selection are depicted as solid lines. p-hacking is depicted as dashed line. Covariate selection methods that control for X are depicted as two dash lines. Covariate selection methods that do not control for X are depicted as long dash lines.\"\n#| fig-height: 6\n#| fig-width: 8\n\n(observations + covs)/(good_covs + ycor) +\n  plot_layout(guides = \"collect\") &\n  theme(legend.position = \"right\")\n```\n\n::: {.cell-output-display}\n![Type I error by method and research setting. Plots are paneled by aspects of the research setting (number of observations, number of covariates, proportioin of good covariates, and Y-covariate correlation strength). Methods are displayed separately by color. Methods with no covariate selection are depicted as solid lines. p-hacking is depicted as dashed line. Covariate selection methods that control for X are depicted as two dash lines. Covariate selection methods that do not control for X are depicted as long dash lines.](mak_figures_files/figure-html/fig-type1-panel-1.png){#fig-type1-panel width=768}\n:::\n:::\n\n::: {#cell-fig-bar-2 .cell}\n\n```{.r .cell-code .hidden}\n#| label: fig-bar-2\n#| fig-cap: \"Type II Error by Method. Average type II error rate across all research settings is displayed for each method separately by color.\"\n\nd_all <- d_03 |>\n  bind_rows(d_05) |> \n  filter(method != \"p-hacking\")\n\ntype_II_summary <- d_all |> \n  group_by(method) |>\n  summarise(type_II = mean(p_value >= 0.05))\n\ntype_II_summary |> \n  ggplot(aes(x = method, y = type_II, fill = method)) +\n  geom_col(color = \"black\") +\n  # ggplot(aes(x = method, y = type_II, fill = method, pattern = method)) +\n  # geom_bar_pattern(\n  #   stat = \"identity\",\n  #   pattern_fill = \"black\",\n  #   pattern_angle = 45,\n  #   pattern_density = 0.1,\n  #   pattern_size = .1,\n  #   pattern_spacing = 0.05,\n  #   color = \"black\") +\n  geom_text(aes(label = sprintf(\"%.3f\", type_II)), vjust = -0.5) +\n  labs(x = NULL,\n       y = \"Type II Error\") +\n  scale_y_continuous(limits = c(0, max(type_II_summary$type_II) * 1.2), \n                     breaks = seq(0, max(type_II_summary$type_II) * 1.2, by = 0.05)) +\n  # scale_pattern_manual(values = method_patterns) +\n  scale_fill_manual(values = method_colors) +\n  theme(axis.text.x = element_text(angle = 45, hjust = 1))\n```\n\n::: {.cell-output-display}\n![Type II Error by Method. Average type II error rate across all research settings is displayed for each method separately by color.](mak_figures_files/figure-html/fig-bar-2-1.png){#fig-bar-2 width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nobservations_2 <- d_all |> \n  group_by(method, n_obs) |> \n  summarise(prop_not_sig = mean(p_value >= 0.05),\n            .groups = \"drop\") |> \n  ggplot(aes(x = n_obs, y = prop_not_sig, color = method, linetype = method)) + \n  geom_line() +\n  scale_x_continuous(breaks = c(50, 100, 150, 200, 300, 400)) +\n  scale_y_continuous(breaks = c(0.10, 0.20, .30, .40, .50, .60, .70 ),\n                    limits = c(0.02, .72)) +\n  labs(y = \"Type II Error\",\n       subtitle = \"Number of Observations\",\n       x = NULL) +\n  scale_linetype_manual(values = method_linetypes) +\n  scale_color_manual(values = method_colors) +\n  theme(legend.title = element_blank())\n\ncovs_2 <- d_all |> \n  group_by(method, n_covs) |> \n  summarise(prop_not_sig = mean(p_value >= 0.05),\n            .groups = \"drop\") |> \n  ggplot(aes(x = n_covs, y = prop_not_sig, color = method, linetype = method)) + \n  geom_line() +\n  scale_x_continuous(breaks = c(4, 8, 12, 16, 20)) +\n  scale_y_continuous(breaks = c(0.10, 0.20, .30, .40, .50, .60, .70 ),\n                    limits = c(0.02, .72)) +\n  labs(y = NULL,\n       x = NULL,\n       subtitle = \"Number of Covariates\") +\n  scale_linetype_manual(values = method_linetypes) +\n  scale_color_manual(values = method_colors) +\n  theme(legend.title = element_blank())\n\ngood_covs_2 <- d_all |> \n  group_by(method, p_good_covs) |> \n  summarise(prop_not_sig = mean(p_value >= 0.05),\n            .groups = \"drop\") |> \n  ggplot(aes(x = p_good_covs, y = prop_not_sig, color = method, linetype = method)) + \n  geom_line() +\n  scale_x_continuous(breaks = c(0.25, 0.50, 0.75)) +\n  scale_y_continuous(breaks = c(0.10, 0.20, .30, .40, .50, .60, .70 ),\n                    limits = c(0.02, .72)) +\n  labs(y = \"Type II Error\",\n       x = NULL,\n       subtitle = \"Proportion of Good Covariates\") +\n  scale_linetype_manual(values = method_linetypes) +\n  scale_color_manual(values = method_colors) +\n  theme(legend.title = element_blank())\n\nycor_2 <- d_all |> \n  group_by(method, r_ycov) |> \n  summarise(prop_not_sig = mean(p_value >= 0.05),\n            .groups = \"drop\") |> \n  ggplot(aes(x = r_ycov, y = prop_not_sig, color = method, linetype = method)) + \n  geom_line() +\n  scale_x_continuous(breaks = c(0.3, 0.5)) +\n  scale_y_continuous(breaks = c(0.10, 0.20, .30, .40, .50, .60, .70 ),\n                    limits = c(0.02, .72)) +\n  labs(y = NULL,\n       x = NULL,\n       subtitle = \"Y-Covariate Correlation Strength\") +\n  scale_linetype_manual(values = method_linetypes) +\n  scale_color_manual(values = method_colors) +\n  theme(legend.title = element_blank())\n\nb_x <- d_all |> \n  group_by(method, b_x) |> \n  summarise(prop_not_sig = mean(p_value >= 0.05),\n            .groups = \"drop\") |> \n  ggplot(aes(x = b_x, y = prop_not_sig, color = method, linetype = method)) + \n  geom_line() +\n  scale_x_continuous(breaks = c(0.3, 0.5)) +\n  scale_y_continuous(breaks = c(0.10, 0.20, .30, .40, .50, .60, .70 ),\n                    limits = c(0.02, .72)) +\n  labs(y = \"Type II Error\",\n       x = NULL,\n       subtitle = \"Population Parameter for X\") +\n  scale_linetype_manual(values = method_linetypes) +\n  scale_color_manual(values = method_colors) +\n  theme(legend.title = element_blank(),\n        legend.position = \"none\")\n```\n:::\n\n::: {#cell-fig-panel-2 .cell}\n\n```{.r .cell-code .hidden}\n#| label: fig-panel-2\n#| fig-cap: \"Type II error by method and research setting. Plots are paneled by aspects of the research setting (number of observations, number of covariates, proportioin of good covariates, Y-covariate correlation strength, and population parameter for X). Methods are displayed separately by color. Methods with no covariate selection are depicted as solid lines. Covariate selection methods that control for X are depicted as two dash lines. Covariate selection methods that do not control for X are depicted as long dash lines.\"\n#| fig-height: 9\n#| fig-width: 7.5\n\n(observations_2 + covs_2)/(good_covs_2 + ycor_2)/(b_x + plot_spacer()) +\n  plot_layout(guides = \"collect\") &\n  theme(legend.position = \"right\")\n```\n\n::: {.cell-output-display}\n![Type II error by method and research setting. Plots are paneled by aspects of the research setting (number of observations, number of covariates, proportioin of good covariates, Y-covariate correlation strength, and population parameter for X). Methods are displayed separately by color. Methods with no covariate selection are depicted as solid lines. Covariate selection methods that control for X are depicted as two dash lines. Covariate selection methods that do not control for X are depicted as long dash lines.](mak_figures_files/figure-html/fig-panel-2-1.png){#fig-panel-2 width=720}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nrm(d_all)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nest_d_0 <- d_0 |> \n  ggplot(aes(x = estimate, color = method, linetype = method)) +\n  geom_density(alpha = 0.5) +\n  geom_vline(xintercept = 0, linetype = \"dotted\", color = \"black\") +\n  scale_x_continuous(limits = c(-0.5, 0.5), breaks = seq(-0.5, 0.5, by = 0.5)) +\n  labs(y = \"Density\",\n       x = \"Estimate\") +\n  scale_linetype_manual(values = method_linetypes) +\n  scale_color_manual(values = method_colors) \n\nest_d_03 <- d_03 |> \n  filter(method != \"p-hacking\") |> \n  ggplot(aes(x = estimate, color = method, linetype = method)) +\n  geom_density(alpha = 0.5) +\n  geom_vline(xintercept = 0.3, linetype = \"dotted\") +\n  scale_x_continuous(limits = c(-0.2, 0.8), breaks = c(0, 0.3, 0.6)) +\n  labs(y = \"Density\",\n       x = \"Estimate\") +\n  scale_linetype_manual(values = method_linetypes) +\n  scale_color_manual(values = method_colors) +\n  theme(legend.position = \"none\")\n\nest_d_05 <- d_05 |> \n  filter(method != \"p-hacking\") |> \n  ggplot(aes(x = estimate, color = method, linetype = method)) +\n  geom_density(alpha = 0.5) +\n  geom_vline(xintercept = 0.5, linetype = \"dotted\") +\n  scale_x_continuous(limits = c(0, 1), breaks = c(0, 0.5, 1)) +\n  labs(y = \"Density\",\n       x = \"Estimate\") + \n  scale_linetype_manual(values = method_linetypes) +\n  scale_color_manual(values = method_colors) +\n  theme(legend.position = \"none\")\n```\n:::\n\n::: {#cell-fig-distribution-bx .cell}\n\n```{.r .cell-code .hidden}\n#| label: fig-distribution-bx\n#| fig-cap: \"Sampling Distribution for Population Parameter Estimates.\"\n#| fig-height: 8\n\nest_d_0 / est_d_03 / est_d_05 \n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nWarning: Removed 798111 rows containing non-finite outside the scale range\n(`stat_density()`).\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nWarning: Removed 522893 rows containing non-finite outside the scale range\n(`stat_density()`).\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nWarning: Removed 529644 rows containing non-finite outside the scale range\n(`stat_density()`).\n```\n\n\n:::\n\n::: {.cell-output-display}\n![Sampling Distribution for Population Parameter Estimates.](mak_figures_files/figure-html/fig-distribution-bx-1.png){#fig-distribution-bx width=672}\n:::\n:::\n",
    "supporting": [
      "mak_figures_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}