---
title: "Make Figures for Main Manuscript"
author: "Lauren Khoury"
date: "`r lubridate::today()`"
number-sections: true
output: 
  html_document:
    toc: true 
    toc_depth: 4
format:
  html:
    embed-resources: true
    toc: true
    toc-depth: 4
editor_options: 
  chunk_output_type: console
execute:
  echo: false
html-table-processing: none
---

```{r}
#| label: set up

library(dplyr) |> suppressMessages()
library(skimr)
library(purrr)
library(ggplot2)
library(patchwork)
library(cowplot)
library(forcats)
library(kableExtra, exclude = ("group_rows"))

theme_set(theme_classic())
method_colors <- c("No covariates" = "sienna",
                   "All covariates" = "goldenrod2",
                   "p-hacking" = "red2",
                   "Bivariate correlation" = "springgreen3",
                   "Partial correlation" = "deepskyblue",
                   "Full linear model" = "mediumpurple1",
                   "Full linear model with X" = "slateblue1",
                   "LASSO" = "hotpink",
                   "LASSO with X" = "lightpink")
method_linetypes <- c("No covariates" = "solid",
                      "All covariates" = "solid",
                      "p-hacking" = "longdash",
                      "Bivariate correlation" = "dashed",
                      "Partial correlation" = "twodash",
                      "Full linear model" = "dashed",
                      "Full linear model with X" = "twodash",
                      "LASSO" = "dashed",
                      "LASSO with X" = "twodash")

devtools::source_url("https://github.com/jjcurtin/lab_support/blob/main/format_path.R?raw=true") |> suppressMessages()

# rdrive_path <- format_path("studydata/cov/raw_data")
rdrive_path <- "\\\\research.drive.wisc.edu\\jjcurtin\\studydata\\cov\\raw_data"
setwd(rdrive_path)

options(digits = 3)

```

```{r}
#| label: read in data

d_0 <- data.table::fread(here::here(rdrive_path, "batch_results_new_method_0.csv"))
d_03 <- data.table::fread(here::here(rdrive_path, "batch_results_new_method_03.csv"))
d_05 <- data.table::fread(here::here(rdrive_path, "batch_results_new_method_05.csv"))

d_20_covs <- data.table::fread(here::here(rdrive_path, "batch_results_20_covs.csv"))
d_n50 <- data.table::fread(here::here(rdrive_path, "batch_results_n50.csv"))

d2_0 <- data.table::fread(here::here(rdrive_path, "batch_results_new_20K_0.csv"))
d2_03 <- data.table::fread(here::here(rdrive_path, "batch_results_new_20K_03.csv"))
d2_05 <- data.table::fread(here::here(rdrive_path, "batch_results_new_20K_05.csv"))

d_wo_x_og <- data.table::fread(here::here(rdrive_path, "batch_results_methods_wo_x_og_seed.csv"))
d_wo_x_new <- data.table::fread(here::here(rdrive_path, "batch_results_methods_wo_x_new_seed.csv"))

```

```{r}
#| label: combine data

d_0 <- rbind(d_0, d_20_covs |> filter(b_x == 0))
d_03 <- rbind(d_03, d_20_covs |> filter(b_x == 0.3))
d_05 <- rbind(d_05, d_20_covs |> filter(b_x == 0.5))

d_0 <- rbind(d_0, d_n50 |> filter(b_x == 0))
d_03 <- rbind(d_03, d_n50 |> filter(b_x == 0.3))
d_05 <- rbind(d_05, d_n50 |> filter(b_x == 0.5))

d_0 <- rbind(d_0, d2_0)
d_03 <- rbind(d_03, d2_03)
d_05 <- rbind(d_05, d2_05)

d_0 <- rbind(d_0, d_wo_x_og |> filter(b_x == 0))
d_0 <- rbind(d_0, d_wo_x_new |> filter(b_x == 0))
d_03 <- rbind(d_03, d_wo_x_og |> filter(b_x == 0.3))
d_03 <- rbind(d_03, d_wo_x_new |> filter(b_x == 0.3))
d_05 <- rbind(d_05, d_wo_x_og |> filter(b_x == 0.5))
d_05 <- rbind(d_05, d_wo_x_new |> filter(b_x == 0.5))

```

```{r}
#| label: factor levels

d_0 <- d_0 |> 
  mutate(method = factor(method, levels = c("no_covs", "all_covs", "p_hacked", "r", 
                                            "partial_r", "full_lm_wo_x", "full_lm",  
                                           "lasso_wo_x", "lasso"),
                         labels = c("No covariates", "All covariates", "p-hacking", 
                                    "Bivariate correlation", "Partial correlation", 
                                    "Full linear model", "Full linear model with X", 
                                            "LASSO", "LASSO with X")))

d_03 <- d_03 |> 
  mutate(method = factor(method, levels = c("no_covs", "all_covs", "p_hacked", "r", 
                                            "partial_r", "full_lm_wo_x", "full_lm",  
                                           "lasso_wo_x", "lasso"),
                         labels = c("No covariates", "All covariates", "p-hacking", 
                                    "Bivariate correlation", "Partial correlation", 
                                    "Full linear model", "Full linear model with X", 
                                            "LASSO", "LASSO with X")))

d_05 <- d_05 |> 
  mutate(method = factor(method, levels = c("no_covs", "all_covs", "p_hacked", "r", 
                                            "partial_r", "full_lm_wo_x", "full_lm",  
                                           "lasso_wo_x", "lasso"),
                         labels = c("No covariates", "All covariates", "p-hacking", 
                                    "Bivariate correlation", "Partial correlation", 
                                    "Full linear model", "Full linear model with X", 
                                            "LASSO", "LASSO with X")))

```

```{r}
#| label: fig-typeI-bar
#| fig-cap: "Type I Error by Method. Average type I error rate across all research settings is displayed for each method separately by color. The horizontal dotted black line indicates expected Type 1 Error rate for an alpha = .05."

type_I_summary <- d_0 |>
  group_by(method) |>
  summarise(type_I = mean(p_value < 0.05))

type_I_summary |> 
  mutate(method = fct_relevel(method, "P-hacking")) |>
  ggplot(aes(x = method, y = type_I, fill = method)) +
  geom_bar(stat = "identity") +
  geom_hline(yintercept = 0.05, linetype = "dotted", color = "black", linewidth = .75) +
  geom_text(aes(label = sprintf("%.3f", type_I)), vjust = -0.5) +
  labs(x = NULL,
       y = "Type I Error",
       fill = "Method") +
  scale_y_continuous(limits = c(0, max(type_I_summary$type_I) * 1.2), 
                     breaks = seq(0, max(type_I_summary$type_I) * 1.2, by = 0.05)) +
  theme(legend.position = "none",
        axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_manual(values = method_colors)

```


<!--add to figure legends: Note that for the line plots throughout this report, a solid line will indicate a method that does not involve performing selection of covariates (i.e., using no or all covariates). A dashed line will indicate a method that does involve performing a non-trivial selection of covariates. A dotted black line will indicate the expected value (if applicable). For example, there will be a dotted line at $\alpha = 0.05$, the signifance level considered here and hence, the expected Type I error rate.-->

```{r}
observations <- d_0 |> 
  group_by(method, n_obs) |> 
  summarise(prop_sig = mean(p_value < 0.05),
            .groups = "drop") |> 
  ggplot(aes(x = n_obs, y = prop_sig, color = method, linetype = method)) + 
  geom_line() +
  geom_hline(yintercept = 0.05, linetype = "dotted", color = "black") +
  scale_x_continuous(breaks = c(50, 100, 150, 200, 300, 400)) +
  scale_y_continuous(breaks = c(0.05, 0.10, 0.15, 0.20, .25, .30),
                     limits = c(0.03, .30)) +
  labs(x = NULL,
       subtitle = "Number of Observations",
       y = "Type I Error") +
  scale_linetype_manual(values = method_linetypes) +
  scale_color_manual(values = method_colors)


covs <- d_0 |> 
  group_by(method, n_covs) |> 
  summarise(prop_sig = mean(p_value < 0.05),
            .groups = "drop") |> 
  ggplot(aes(x = n_covs, y = prop_sig, color = method, linetype = method)) + 
  geom_line() +
  geom_hline(yintercept = 0.05, linetype = "dotted", color = "black") +
  scale_x_continuous(breaks = c(4, 8, 12, 16, 20)) +
  scale_y_continuous(breaks = c(0.05, 0.10, 0.15, 0.20, 0.25, .30),
                     limits = c(.03, .30)) +
  labs(y = "Type I Error",
       x = NULL,
       subtitle = "Number of Covariates") +
  scale_linetype_manual(values = method_linetypes) +
  scale_color_manual(values = method_colors)

good_covs <- d_0 |> 
  group_by(method, p_good_covs) |> 
  summarise(prop_sig = mean(p_value < 0.05),
            .groups = "drop") |> 
  ggplot(aes(x = p_good_covs, y = prop_sig, color = method, linetype = method)) + 
  geom_line() +
  geom_hline(yintercept = 0.05, linetype = "dotted", color = "black") +
  scale_x_continuous(breaks = c(0.25, 0.50, 0.75)) +
  scale_y_continuous(breaks = c(0.05, 0.10, 0.15, 0.20, .25, .30), 
                     limits = c(.03, .30)) +
  labs(y = "Type I Error",
       x = NULL,
       subtitle = "Proportion of Good Covariates") +
  scale_linetype_manual(values = method_linetypes) +
  scale_color_manual(values = method_colors)

ycor <- d_0 |> 
  group_by(method, r_ycov) |> 
  summarise(prop_sig = mean(p_value < 0.05),
            .groups = "drop") |> 
  ggplot(aes(x = r_ycov, y = prop_sig, color = method, linetype = method)) + 
  geom_line() +
  geom_hline(yintercept = 0.05, linetype = "dotted", color = "black") +
  scale_x_continuous(breaks = c(0.3, 0.5)) +
  scale_y_continuous(breaks = c(0.05, 0.10, 0.15, 0.20, 0.25, 0.30), 
                     limits = c(.03, .30)) +
  labs(y = "Type I Error",
       x = NULL,
       subtitle = "Y-Covariate Correlation") +
  scale_linetype_manual(values = method_linetypes) +
  scale_color_manual(values = method_colors)

```


```{r}
#| label: fig-type1-panel
#| fig-cap:

(observations + covs)/(good_covs + ycor) +
  plot_layout(guides = "collect") &
  theme(legend.position = "bottom")
```


```{r}
#| label: fig-distribution-bx-0
#| fig-cap: "Sampling Distribution for b_x=0 Estimate"

d_0 |> 
  ggplot(aes(x = estimate, color = method, linetype = method)) +
  geom_density(alpha = 0.5) +
  geom_vline(xintercept = 0, linetype = "dotted", color = "black") +
  scale_x_continuous(limits = c(-0.5, 0.5), breaks = seq(-0.5, 0.5, by = 0.5)) +
  labs(y = "Density",
       x = "Estimate") +
  scale_linetype_manual(values = method_linetypes) +
  scale_color_manual(values = method_colors)

```

```{r}
#| label: fig-typeII-bar-03
#| fig-cap: "Type II Error by Method, b_x=0.3"

type_II_summary_03 <- d_03 |>
  filter(method != "p_hacked") |> 
  group_by(method) |>
  summarise(type_II = mean(p_value >= 0.05))

type_II_summary_03 |> 
ggplot(aes(x = method, y = type_II, fill = method)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label = sprintf("%.3f", type_II)), vjust = -0.5) +
  labs(x = "Method",
       y = "Type II Error",
       fill = "Method") +
  scale_y_continuous(limits = c(0, max(type_II_summary_03$type_II) * 1.2), 
                     breaks = seq(0, max(type_II_summary_03$type_II) * 1.2, by = 0.05)) +
  theme_minimal() +
  theme(legend.position = "none",
        axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_manual(values = method_colors)

```

```{r}
#| label: fig-typeII-bar-05
#| fig-cap: "Type II Error by Method, b_x=0.5"

type_II_summary_05 <- d_05 |>
  filter(method != "p_hacked") |> 
  group_by(method) |>
  summarise(type_II = mean(p_value >= 0.05))

type_II_summary_05 |> 
ggplot(aes(x = method, y = type_II, fill = method)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label = sprintf("%.3f", type_II)), vjust = -0.5) +
  labs(x = "Method",
       y = "Type II Error",
       fill = "Method") +
  scale_y_continuous(limits = c(0, max(type_II_summary_05$type_II) * 1.2), 
                     breaks = seq(0, max(type_II_summary_05$type_II) * 1.2, by = 0.05)) +
  theme_minimal() +
  theme(legend.position = "none",
        axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_manual(values = method_colors)

```

```{r}
#| label: fig-typeII-nobs-03
#| fig-cap: "Type II Error by Number of Observations, b_x=0.3"

d_03 |> 
  filter(method != "p_hacked") |> 
  group_by(method, n_obs) |> 
  summarise(prop_not_sig = mean(p_value >= 0.05),
            .groups = "drop") |> 
  ggplot(aes(x = n_obs, y = prop_not_sig, color = method, linetype = method)) + 
  geom_line() +
  scale_x_continuous(breaks = c(50, 100, 150, 200, 300, 400)) +
  labs(y = "Type II Error",
       x = "Number of Observations") +
  scale_linetype_manual(values = method_linetypes) +
  scale_color_manual(values = method_colors)

```

```{r}
#| label: fig-typeII-nobs-05
#| fig-cap: "Type II Error by Number of Observations, b_x=0.5"

d_05 |> 
  filter(method != "p_hacked") |>
  group_by(method, n_obs) |> 
  summarise(prop_not_sig = mean(p_value >= 0.05),
            .groups = "drop") |> 
  ggplot(aes(x = n_obs, y = prop_not_sig, color = method, linetype = method)) + 
  geom_line() +
  scale_x_continuous(breaks = c(50, 100, 150, 200, 300, 400)) +
  labs(y = "Type II Error",
       x = "Number of Observations") +
  scale_linetype_manual(values = method_linetypes) +
  scale_color_manual(values = method_colors)

```

```{r}
#| label: fig-typeII-ncovs-03
#| fig-cap: "Type II Error by Number of Covariates, b_x=0.3"

d_03 |> 
  filter(method != "p_hacked") |> 
  group_by(method, n_covs) |> 
  summarise(prop_not_sig = mean(p_value >= 0.05),
            .groups = "drop") |> 
  ggplot(aes(x = n_covs, y = prop_not_sig, color = method, linetype = method)) + 
  geom_line() +
  scale_x_continuous(breaks = c(4, 8, 12, 16, 20)) +
  labs(y = "Type II Error",
       x = "Number of Covariates") +
  scale_linetype_manual(values = method_linetypes) +
  scale_color_manual(values = method_colors)

```

```{r}
#| label: fig-typeII-ncovs-05
#| fig-cap: "Type II Error by Number of Covariates, b_x=0.5"

d_05 |> 
  filter(method != "p_hacked") |> 
  group_by(method, n_covs) |> 
  summarise(prop_not_sig = mean(p_value >= 0.05),
            .groups = "drop") |> 
  ggplot(aes(x = n_covs, y = prop_not_sig, color = method, linetype = method)) + 
  geom_line() +
  scale_x_continuous(breaks = c(4, 8, 12, 16, 20)) +
  labs(y = "Type II Error",
       x = "Number of Covariates") +
  scale_linetype_manual(values = method_linetypes) +
  scale_color_manual(values = method_colors)

```

```{r}
#| label: fig-typeII-pgoodcovs-03
#| fig-cap: "Type II Error by Proportion of Good Covariates, b_x=0.3"

d_03 |> 
  filter(method != "p_hacked") |> 
  group_by(method, p_good_covs) |> 
  summarise(prop_not_sig = mean(p_value >= 0.05),
            .groups = "drop") |> 
  ggplot(aes(x = p_good_covs, y = prop_not_sig, color = method, linetype = method)) + 
  geom_line() +
  scale_x_continuous(breaks = c(0.25, 0.50, 0.75)) +
  labs(y = "Type II Error",
       x = "Proportion of Good Covariates") +
  scale_linetype_manual(values = method_linetypes) +
  scale_color_manual(values = method_colors)

```

```{r}
#| label: fig-typeII-pgoodcovs-05
#| fig-cap: "Type II Error by Proportion of Good Covariates, b_x=0.5"

d_05 |> 
  filter(method != "p_hacked") |> 
  group_by(method, p_good_covs) |> 
  summarise(prop_not_sig = mean(p_value >= 0.05),
            .groups = "drop") |> 
  ggplot(aes(x = p_good_covs, y = prop_not_sig, color = method, linetype = method)) + 
  geom_line() +
  scale_x_continuous(breaks = c(0.25, 0.50, 0.75)) +
  labs(y = "Type II Error",
       x = "Proportion of Good Covariates") +
  scale_linetype_manual(values = method_linetypes) +
  scale_color_manual(values = method_colors)

```

```{r}
#| label: fig-typeII-rycov-03
#| fig-cap: "Type II Error by Y-Covariate Correlation, b_x=0.3"

d_03 |> 
  filter(method != "p_hacked") |> 
  group_by(method, r_ycov) |> 
  summarise(prop_not_sig = mean(p_value >= 0.05),
            .groups = "drop") |> 
  ggplot(aes(x = r_ycov, y = prop_not_sig, color = method, linetype = method)) + 
  geom_line() +
  scale_x_continuous(breaks = c(0.3, 0.5)) +
  labs(y = "Type II Error",
       x = "Y-Covariate Correlation") +
  scale_linetype_manual(values = method_linetypes) +
  scale_color_manual(values = method_colors)

```

```{r}
#| label: fig-typeII-rycov-05
#| fig-cap: "Type II Error by Y-Covariate Correlation, b_x=0.5"

d_05 |> 
  filter(method != "p_hacked") |> 
  group_by(method, r_ycov) |> 
  summarise(prop_not_sig = mean(p_value >= 0.05),
            .groups = "drop") |> 
  ggplot(aes(x = r_ycov, y = prop_not_sig, color = method, linetype = method)) + 
  geom_line() +
  scale_x_continuous(breaks = c(0.3, 0.5)) +
  labs(y = "Type II Error",
       x = "Y-Covariate Correlation") +
  scale_linetype_manual(values = method_linetypes) +
  scale_color_manual(values = method_colors)

```

```{r}
#| label: fig-distribution-bx-03
#| fig-cap: "Sampling Distribution for b_x=0.3 Estimate"

d_03 |> 
  filter(method != "p_hacked") |> 
  ggplot(aes(x = estimate, color = method, linetype = method)) +
  geom_density(alpha = 0.5) +
  geom_vline(xintercept = 0.3, linetype = "dotted") +
  scale_x_continuous(limits = c(-0.2, 0.8), breaks = c(0, 0.3, 0.6)) +
  labs(y = "Density",
       x = "Estimate") +
  scale_linetype_manual(values = method_linetypes) +
  scale_color_manual(values = method_colors)

```

```{r}
#| label: fig-distribution-bx-05
#| fig-cap: "Sampling Distribution for b_x=0.5 Estimate"

d_05 |> 
  filter(method != "p_hacked") |> 
  ggplot(aes(x = estimate, color = method, linetype = method)) +
  geom_density(alpha = 0.5) +
  geom_vline(xintercept = 0.5, linetype = "dotted") +
  scale_x_continuous(limits = c(0, 1), breaks = c(0, 0.5, 1)) +
  labs(y = "Density",
       x = "Estimate") + 
  scale_linetype_manual(values = method_linetypes) +
  scale_color_manual(values = method_colors)

```








