---
title: "Analysis of Covariate Results"
author: "Lauren Khoury"
date: "`r lubridate::today()`"
format: 
  html: 
    embed-resources: true
    toc: true 
    toc_depth: 5
    fig-width: 9
    fig-height: 7
editor_options: 
  chunk_output_type: console
---

## Set up

### load packages, set path

```{r packages}

# load packages + set ggplot theme

library(dplyr) |> suppressMessages()
library(skimr)
library(purrr)
library(ggplot2)
library(cowplot)
library(kableExtra, exclude = ("group_rows"))

theme_set(theme_classic())

# format path 

devtools::source_url("https://github.com/jjcurtin/lab_support/blob/main/format_path.R?raw=true") |> suppressMessages()

rdrive_path <- format_path("studydata/cov/raw_data")

```

### read in data

All data has: 1440 jobs $\times$ 500 simulations each $\times$ 5 models = 3,600,000 observations. <br>

Read in data for $b_x = 0$ & uncorrelated covariates.

```{r read in data uncorr b0}

d_uncorr_0 <- read.csv(here::here(rdrive_path, "batch_results_uncorrelated_0.csv")) |> 
  mutate(model = gsub("[ -]", "_", model),
         model = factor(model, c("lm_no_covs",
                                 "lm_all_covs",
                                 "lm_p_hacked",
                                 "lm_partial_r",
                                 "lm_lasso"))) |> 
  glimpse()

```

<br>
Read in data for $b_x = 0$ & correlated covariates.

```{r read in data corr b0}

d_corr_0 <- read.csv(here::here(rdrive_path, "batch_results_correlated_0.csv")) |> 
  mutate(model = gsub("[ -]", "_", model),
         model = factor(model, c("lm_no_covs",
                                 "lm_all_covs",
                                 "lm_p_hacked",
                                 "lm_partial_r",
                                 "lm_lasso"))) |> 
  glimpse()

```

<br>
Read in data for $b_x = 0.5$ & uncorrelated covariates.

```{r read in data uncorr b05}

d_uncorr_05 <- read.csv(here::here(rdrive_path, "batch_results_uncorrelated_05.csv")) |> 
  mutate(model = gsub("[ -]", "_", model),
         model = factor(model, c("lm_no_covs",
                                 "lm_all_covs",
                                 "lm_p_hacked",
                                 "lm_partial_r",
                                 "lm_lasso"))) |> 
  glimpse()

```

<br>
Read in data for $b_x = 0.5$ & correlated covariates. <br>

```{r read in data corr b05}

d_corr_05 <- read.csv(here::here(rdrive_path, "batch_results_correlated_05.csv")) |> 
  mutate(model = gsub("[ -]", "_", model),
         model = factor(model, c("lm_no_covs",
                                 "lm_all_covs",
                                 "lm_p_hacked",
                                 "lm_partial_r",
                                 "lm_lasso"))) |> 
  glimpse()

```


# Data Analysis

## Type I and Type II error

### by model

Overall proportion significaint ($p < 0.05$) by model; the Type I error.

```{r type I by model uncorr}

d_uncorr_0 |> 
  group_by(model) |> 
  summarise(proportion_significant = mean(p_value < 0.05)) |> 
  kbl(caption = "uncorrelated, b_x = 0")

```

```{r type I by model corr}

d_corr_0 |> 
  group_by(model) |> 
  summarise(proportion_significant = mean(p_value < 0.05)) |> 
  kbl(caption = "correlated, b_x = 0")

```

<br>
Overall proportion not significaint ($p >= 0.05$) by model; the Type II error.

```{r type II by model uncorr}

d_uncorr_05 |> 
  group_by(model) |> 
  summarise(proportion_not_significant = mean(p_value >= 0.05)) |> 
  kbl(caption = "uncorrelated, b_x = 0.5")

```

```{r type II by model corr}

d_corr_05 |> 
  group_by(model) |> 
  summarise(proportion_not_significant = mean(p_value >= 0.05)) |> 
  kbl(caption = "correlated, b_x = 0.5")

```

### by n_obs

#### type I error

```{r type I n obs uncorr}

d_uncorr_0 |> 
  group_by(model, n_obs, b_x, n_covs, r_ycov, p_good_covs, r_cov) |> 
  summarise(prop_sig = mean(p_value < 0.05),
            .groups = "drop") |> 
  group_by(model, n_obs) |> 
  summarise(typeI_min = min(prop_sig),
            typeI_mean = mean(prop_sig),
            typeI_max = max(prop_sig),
            .groups = "drop") |> 
  kbl(caption = "type I error by n_obs, uncorrelated")

```

```{r type I n obs corr}

d_corr_0 |> 
  group_by(model, n_obs, b_x, n_covs, r_ycov, p_good_covs, r_cov) |> 
  summarise(prop_sig = mean(p_value < 0.05),
            .groups = "drop") |> 
  group_by(model, n_obs) |> 
  summarise(typeI_min = min(prop_sig),
            typeI_mean = mean(prop_sig),
            typeI_max = max(prop_sig),
            .groups = "drop") |> 
  kbl(caption = "type I error by n_obs, correlated")

```

#### type II error

```{r type II n obs uncorr}

d_uncorr_05 |> 
  group_by(model, n_obs, b_x, n_covs, r_ycov, p_good_covs, r_cov) |> 
  summarise(prop_not_sig = mean(p_value >= 0.05),
            .groups = "drop") |> 
  group_by(model, n_obs) |> 
  summarise(typeII_min = min(prop_not_sig),
            typeII_mean = mean(prop_not_sig),
            typeII_max = max(prop_not_sig),
            .groups = "drop") |> 
  kbl(caption = "type II error by n_obs, uncorrelated")

```

```{r type II n obs corr}

d_corr_05 |> 
  group_by(model, n_obs, b_x, n_covs, r_ycov, p_good_covs, r_cov) |> 
  summarise(prop_not_sig = mean(p_value >= 0.05),
            .groups = "drop") |> 
  group_by(model, n_obs) |> 
  summarise(typeII_min = min(prop_not_sig),
            typeII_mean = mean(prop_not_sig),
            typeII_max = max(prop_not_sig),
            .groups = "drop") |> 
  kbl(caption = "type II error by n_obs, correlated")

```

#### plots 

Uncorrelated.

```{r plot type I II n obs uncorr}

p0_nobs_uncorr <- d_uncorr_0 |> 
  group_by(model, n_obs) |> 
  summarise(prop_sig = mean(p_value < 0.05),
            .groups = "drop") |> 
  ggplot(aes(x = n_obs, y = prop_sig, color = model)) + 
  geom_line() +
  scale_color_manual(values = c("dodgerblue", "deeppink", "chartreuse3", "mediumpurple2", "darkorange" )) +
  labs(y = "Type I error")

p05_nobs_uncorr <- d_uncorr_05 |> 
  group_by(model, n_obs) |> 
  summarise(prop_not_sig = mean(p_value >= 0.05),
            .groups = "drop") |> 
  ggplot(aes(x = n_obs, y = prop_not_sig, color = model)) + 
  geom_line() +
  scale_color_manual(values = c("dodgerblue", "deeppink", "chartreuse3", "mediumpurple2", "darkorange" )) +
  labs(y = "Type II error") +
  theme(legend.position = "none")

plot_grid(p0_nobs_uncorr + theme(legend.position = "none"), 
          p05_nobs_uncorr,
          get_legend(p0_nobs_uncorr),
          ncol = 3)

```

Correlated.

```{r plot type I II n obs corr}

p0_nobs_corr <- d_corr_0 |> 
  group_by(model, n_obs) |> 
  summarise(prop_sig = mean(p_value < 0.05),
            .groups = "drop") |> 
  ggplot(aes(x = n_obs, y = prop_sig, color = model)) + 
  geom_line() +
  scale_color_manual(values = c("dodgerblue", "deeppink", "chartreuse3", "mediumpurple2", "darkorange" )) +
  labs(y = "Type I error")

p05_nobs_corr <- d_corr_05 |> 
  group_by(model, n_obs) |> 
  summarise(prop_not_sig = mean(p_value >= 0.05),
            .groups = "drop") |> 
  ggplot(aes(x = n_obs, y = prop_not_sig, color = model)) + 
  geom_line() +
  scale_color_manual(values = c("dodgerblue", "deeppink", "chartreuse3", "mediumpurple2", "darkorange" )) +
  labs(y = "Type II error") +
  theme(legend.position = "none")

plot_grid(p0_nobs_corr + theme(legend.position = "none"), 
          p05_nobs_corr,
          get_legend(p0_nobs_corr),
          ncol = 3)

```

### by n_covs and p_good_covs

#### type I error

```{r type I n covs p covs uncorr}

d_uncorr_0 |> 
  group_by(model, n_obs, b_x, n_covs, r_ycov, p_good_covs, r_cov) |> 
  summarise(prop_sig = mean(p_value < 0.05),
            .groups = "drop") |> 
  group_by(model, n_covs, p_good_covs) |> 
  summarise(typeI_min = min(prop_sig),
            typeI_mean = mean(prop_sig),
            typeI_max = max(prop_sig),
            .groups = "drop") |> 
  kbl(caption = "type I error by n_covs and p_good_covs, uncorrelated")

```

```{r type I n covs p covs corr}

d_corr_0 |> 
  group_by(model, n_obs, b_x, n_covs, r_ycov, p_good_covs, r_cov) |> 
  summarise(prop_sig = mean(p_value < 0.05),
            .groups = "drop") |> 
  group_by(model, n_covs, p_good_covs) |> 
  summarise(typeI_min = min(prop_sig),
            typeI_mean = mean(prop_sig),
            typeI_max = max(prop_sig),
            .groups = "drop") |> 
  kbl(caption = "type I error by n_covs and p_good_covs, correlated")

```

#### type II error

```{r type II n covs p covs uncorr}

d_uncorr_05 |> 
  group_by(model, n_obs, b_x, n_covs, r_ycov, p_good_covs, r_cov) |> 
  summarise(prop_not_sig = mean(p_value >= 0.05),
            .groups = "drop") |> 
  group_by(model, n_covs, p_good_covs) |> 
  summarise(typeII_min = min(prop_not_sig),
            typeII_mean = mean(prop_not_sig),
            typeII_max = max(prop_not_sig),
            .groups = "drop") |> 
  kbl(caption = "type II error by n_covs and p_good_covs, uncorrelated")

```

```{r type II n covs p covs corr}

d_corr_05 |> 
  group_by(model, n_obs, b_x, n_covs, r_ycov, p_good_covs, r_cov) |> 
  summarise(prop_not_sig = mean(p_value >= 0.05),
            .groups = "drop") |> 
  group_by(model, n_covs, p_good_covs) |> 
  summarise(typeII_min = min(prop_not_sig),
            typeII_mean = mean(prop_not_sig),
            typeII_max = max(prop_not_sig),
            .groups = "drop") |> 
  kbl(caption = "type II error by n_covs and p_good_covs, correlated")

```

#### plots 

```{r plot type I three way int}

d_uncorr_0 |> 
  group_by(model, n_covs, p_good_covs) |> 
  summarise(prop_sig = mean(p_value < 0.05),
            .groups = "drop") |> 
  ggplot(aes(x = n_covs, y = prop_sig, color = factor(p_good_covs))) + 
  geom_line() +
  facet_grid(~ model) +
  labs(y = "type I error",
       color = "p_good_covs", 
       title = "Three-Way Interaction, uncorrelated") +
  scale_color_manual(values = c("0.25" = "blue", "0.5" = "forestgreen", "0.75" = "orange"))

d_corr_0 |> 
  group_by(model, n_covs, p_good_covs) |> 
  summarise(prop_sig = mean(p_value < 0.05),
            .groups = "drop") |> 
  ggplot(aes(x = n_covs, y = prop_sig, color = factor(p_good_covs))) + 
  geom_line() +
  facet_grid(~ model) +
  labs(y = "type I error",
       color = "p_good_covs",
       title = "Three-Way Interaction, correlated") +
  scale_color_manual(values = c("0.25" = "blue", "0.5" = "forestgreen", "0.75" = "orange"))

```

```{r plot type II three way int}

d_uncorr_05 |> 
  group_by(model, n_covs, p_good_covs) |> 
  summarise(prop_not_sig = mean(p_value >= 0.05),
            .groups = "drop") |> 
  ggplot(aes(x = n_covs, y = prop_not_sig, color = factor(p_good_covs))) + 
  geom_line() +
  facet_grid(~ model) +
  labs(y = "type II error",
       color = "p_good_covs", 
       title = "Three-Way Interaction, uncorrelated") +
  scale_color_manual(values = c("0.25" = "blue", "0.5" = "forestgreen", "0.75" = "orange"))

d_corr_05 |> 
  group_by(model, n_covs, p_good_covs) |> 
  summarise(prop_not_sig = mean(p_value >= 0.05),
            .groups = "drop") |> 
  ggplot(aes(x = n_covs, y = prop_not_sig, color = factor(p_good_covs))) + 
  geom_line() +
  facet_grid(~ model) +
  labs(y = "type II error",
       color = "p_good_covs",
       title = "Three-Way Interaction, correlated") +
  scale_color_manual(values = c("0.25" = "blue", "0.5" = "forestgreen", "0.75" = "orange"))

```

## Sampling Distributions

```{r combined hist}

d_uncorr_0 |> 
  ggplot(aes(x = estimate, color = model)) +
  geom_density(alpha = 0.5) +
  scale_x_continuous(limits = c(-1.5, 1.5), breaks = seq(-1.5, 1.5, by = 0.5)) +
  scale_color_manual(values = c("dodgerblue", "deeppink", "chartreuse3", "mediumpurple2", "darkorange" )) +
  labs(title = "Sampling Distribution for b_x = 0, uncorrelated")

d_uncorr_05 |> 
  ggplot(aes(x = estimate, color = model)) +
  geom_density(alpha = 0.5) +
  scale_x_continuous(limits = c(-1.5, 1.5), breaks = seq(-1.5, 1.5, by = 0.5)) +
  scale_color_manual(values = c("dodgerblue", "deeppink", "chartreuse3", "mediumpurple2", "darkorange" )) +
  labs(title = "Sampling Distribution for b_x = 0.5, uncorrelated")

d_corr_0 |> 
  ggplot(aes(x = estimate, color = model)) +
  geom_density(alpha = 0.5) +
  scale_x_continuous(limits = c(-1.5, 1.5), breaks = seq(-1.5, 1.5, by = 0.5)) +
  scale_color_manual(values = c("dodgerblue", "deeppink", "chartreuse3", "mediumpurple2", "darkorange" )) +
  labs(title = "Sampling Distribution for b_x = 0, correlated")

d_corr_05 |> 
  ggplot(aes(x = estimate, color = model)) +
  geom_density(alpha = 0.5) +
  scale_x_continuous(limits = c(-1.5, 1.5), breaks = seq(-1.5, 1.5, by = 0.5)) +
  scale_color_manual(values = c("dodgerblue", "deeppink", "chartreuse3", "mediumpurple2", "darkorange" )) +
  labs(title = "Sampling Distribution for b_x = 0.5, correlated")

```

## Average Estimate and SE

```{r b se by model}

d_uncorr_0 |> 
  group_by(model) |> 
  summarise(mean_estimate = mean(estimate),
            SD_estimate = sd(estimate),
            mean_SE = sqrt(mean(SE^2))) |> 
  kbl(caption = "b_x = 0, uncorrelated")

d_uncorr_05 |> 
  group_by(model) |> 
  summarise(mean_estimate = mean(estimate),
            SD_estimate = sd(estimate),
            mean_SE = sqrt(mean(SE^2))) |> 
  kbl(caption = "b_x = 0.5, uncorrelated")

d_corr_0 |> 
  group_by(model) |> 
  summarise(mean_estimate = mean(estimate),
            SD_estimate = sd(estimate),
            mean_SE = sqrt(mean(SE^2))) |> 
  kbl(caption = "b_x = 0, correlated")

d_corr_05 |> 
  group_by(model) |> 
  summarise(mean_estimate = mean(estimate),
            SD_estimate = sd(estimate),
            mean_SE = sqrt(mean(SE^2))) |> 
  kbl(caption = "b_x = 0.5, correlated")

```
