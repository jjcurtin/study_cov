---
title: "Analysis of Covariate Results"
author: "Lauren Khoury"
date: "`r lubridate::today()`"
format: 
  html: 
    embed-resources: true
    toc: true 
    toc_depth: 5
    fig-width: 9
    fig-height: 7
editor_options: 
  chunk_output_type: console
---

## Set up

### load packages, set path

```{r packages}

# load packages + set ggplot theme

library(dplyr) |> suppressMessages()
library(skimr)
library(purrr)
library(ggplot2)
library(cowplot)
library(kableExtra, exclude = ("group_rows"))

theme_set(theme_classic())

# format path 

devtools::source_url("https://github.com/jjcurtin/lab_support/blob/main/format_path.R?raw=true") |> suppressMessages()

rdrive_path <- format_path("studydata/cov/raw_data")

```

### read in data

All data has: 192 unique jobs $\times$ 20,000 simulations each $\times$ 5 methods = 19,200,000 observations. <br>

Read in data for $b_x = 0$ & $b_x = 0.5$.

```{r read in data}

d_corr_0 <- data.table::fread(here::here(rdrive_path, "batch_results_correlated_0305_0.csv")) |> 
  glimpse()

d_corr_05 <- data.table::fread(here::here(rdrive_path, "batch_results_correlated_0305_05.csv")) |> 
  glimpse()

beepr::beep()

```

```{r factor method}

d_corr_0 <- d_corr_0 |>
  mutate(method = factor(method, c("no_covs", "all_covs", "p_hacked", "partial_r", "lasso")))

d_corr_05 <- d_corr_05 |>
  mutate(method = factor(method, c("no_covs", "all_covs", "p_hacked", "partial_r", "lasso")))

```


# Data Analysis

## Type I and Type II error

### by method

Overall proportion significaint ($p < 0.05$) by method; the Type I error.

```{r type I by method corr}

d_corr_0 |> 
  group_by(method) |> 
  summarise(proportion_significant = mean(p_value < 0.05)) |> 
  kbl(caption = "b_x = 0")

```

<br>
Overall proportion not significaint ($p >= 0.05$) by method; the Type II error.

```{r type II by method corr}

d_corr_05 |> 
  group_by(method) |> 
  summarise(proportion_not_significant = mean(p_value >= 0.05)) |> 
  kbl(caption = "b_x = 0.5")

```

### by n_obs

#### type I error

```{r type I n obs}

d_corr_0 |> 
  group_by(method, n_obs, b_x, n_covs, r_ycov, p_good_covs, r_cov) |> 
  summarise(prop_sig = mean(p_value < 0.05),
            .groups = "drop") |> 
  group_by(method, n_obs) |> 
  summarise(typeI_min = min(prop_sig),
            typeI_max = max(prop_sig),
            typeI_mean = mean(prop_sig),
            .groups = "drop") |> 
  kbl(caption = "type I error by n_obs")

```

#### type II error

```{r type II n obs}

d_corr_05 |> 
  group_by(method, n_obs, b_x, n_covs, r_ycov, p_good_covs, r_cov) |> 
  summarise(prop_not_sig = mean(p_value >= 0.05),
            .groups = "drop") |> 
  group_by(method, n_obs) |> 
  summarise(typeII_min = min(prop_not_sig),
            typeII_max = max(prop_not_sig),
            typeII_mean = mean(prop_not_sig),
            .groups = "drop") |> 
  kbl(caption = "type II error by n_obs")

```

#### plots

```{r plot type I II n obs}

p0_nobs_corr <- d_corr_0 |> 
  group_by(method, n_obs) |> 
  summarise(prop_sig = mean(p_value < 0.05),
            .groups = "drop") |> 
  ggplot(aes(x = n_obs, y = prop_sig, color = method)) + 
  geom_line() +
  scale_x_continuous(breaks = c(100,200,400,1000)) +
  scale_color_manual(values = c("dodgerblue", "deeppink", "chartreuse3", "mediumpurple2", "darkorange" )) +
  labs(y = "Type I error")

p05_nobs_corr <- d_corr_05 |> 
  group_by(method, n_obs) |> 
  summarise(prop_not_sig = mean(p_value >= 0.05),
            .groups = "drop") |> 
  ggplot(aes(x = n_obs, y = prop_not_sig, color = method)) + 
  geom_line() +
  scale_x_continuous(breaks = c(100,200,400,1000)) +
  scale_color_manual(values = c("dodgerblue", "deeppink", "chartreuse3", "mediumpurple2", "darkorange" )) +
  labs(y = "Type II error") +
  theme(legend.position = "none")

plot_grid(p0_nobs_corr + theme(legend.position = "none"), 
          p05_nobs_corr,
          get_legend(p0_nobs_corr),
          ncol = 3)

```

### by n_covs and p_good_covs

#### type I error

```{r type I n covs p covs}

d_corr_0 |> 
  group_by(method, n_obs, b_x, n_covs, r_ycov, p_good_covs, r_cov) |> 
  summarise(prop_sig = mean(p_value < 0.05),
            .groups = "drop") |> 
  group_by(method, n_covs, p_good_covs) |> 
  summarise(typeI_min = min(prop_sig),
            typeI_max = max(prop_sig),
            typeI_mean = mean(prop_sig),
            .groups = "drop") |> 
  kbl(caption = "type I error by n_covs and p_good_covs")

```

#### type II error

```{r type II n covs p covs}

d_corr_05 |> 
  group_by(method, n_obs, b_x, n_covs, r_ycov, p_good_covs, r_cov) |> 
  summarise(prop_not_sig = mean(p_value >= 0.05),
            .groups = "drop") |> 
  group_by(method, n_covs, p_good_covs) |> 
  summarise(typeII_min = min(prop_not_sig),
            typeII_max = max(prop_not_sig),
            typeII_mean = mean(prop_not_sig),
            .groups = "drop") |> 
  kbl(caption = "type II error by n_covs and p_good_covs")

```

#### plots 

```{r plot type I three way int}

d_corr_0 |> 
  group_by(method, n_covs, p_good_covs) |> 
  summarise(prop_sig = mean(p_value < 0.05),
            .groups = "drop") |> 
  ggplot(aes(x = n_covs, y = prop_sig, color = factor(p_good_covs))) + 
  geom_line() +
  facet_grid(~ method) +
  labs(y = "type I error",
       color = "p_good_covs",
       title = "Three-Way Interaction") +
  scale_color_manual(values = c("0.25" = "blue", "0.5" = "forestgreen", "0.75" = "orange"))

# drop p hack

d_corr_0 |> 
  filter(method != "lm_p_hacked") |> 
  group_by(method, n_covs, p_good_covs) |> 
  summarise(prop_sig = mean(p_value < 0.05),
            .groups = "drop") |> 
  ggplot(aes(x = n_covs, y = prop_sig, color = factor(p_good_covs))) + 
  geom_line() +
  facet_grid(~ method) +
  labs(y = "type I error",
       color = "p_good_covs",
       title = "Three-Way Interaction") +
  scale_color_manual(values = c("0.25" = "blue", "0.5" = "forestgreen", "0.75" = "orange"))

```

```{r plot type II three way int}

d_corr_05 |> 
  group_by(method, n_covs, p_good_covs) |> 
  summarise(prop_not_sig = mean(p_value >= 0.05),
            .groups = "drop") |> 
  ggplot(aes(x = n_covs, y = prop_not_sig, color = factor(p_good_covs))) + 
  geom_line() +
  facet_grid(~ method) +
  labs(y = "type II error",
       color = "p_good_covs",
       title = "Three-Way Interaction") +
  scale_color_manual(values = c("0.25" = "blue", "0.5" = "forestgreen", "0.75" = "orange"))

# drop p hack

d_corr_05 |> 
  filter(method != "lm_p_hacked") |> 
  group_by(method, n_covs, p_good_covs) |> 
  summarise(prop_not_sig = mean(p_value >= 0.05),
            .groups = "drop") |> 
  ggplot(aes(x = n_covs, y = prop_not_sig, color = factor(p_good_covs))) + 
  geom_line() +
  facet_grid(~ method) +
  labs(y = "type II error",
       color = "p_good_covs",
       title = "Three-Way Interaction") +
  scale_color_manual(values = c("0.25" = "blue", "0.5" = "forestgreen", "0.75" = "orange"))

```

### by correlations

```{r type I corrs}

d_corr_0 |> 
  group_by(method, n_obs, b_x, n_covs, r_ycov, p_good_covs, r_cov) |> 
  summarise(prop_sig = mean(p_value < 0.05),
            .groups = "drop") |> 
  group_by(method, r_ycov, r_cov) |> 
  summarise(typeI_min = min(prop_sig),
            typeI_max = max(prop_sig),
            typeI_mean = mean(prop_sig),
            .groups = "drop") |> 
  kbl(caption = "type I error by correlations")

```

```{r type II corrs}

d_corr_05 |> 
  group_by(method, n_obs, b_x, n_covs, r_ycov, p_good_covs, r_cov) |> 
  summarise(prop_not_sig = mean(p_value >= 0.05),
            .groups = "drop") |> 
  group_by(method, r_ycov, r_cov) |> 
  summarise(typeII_min = min(prop_not_sig),
            typeII_max = max(prop_not_sig),
            typeII_mean = mean(prop_not_sig),
            .groups = "drop") |> 
  kbl(caption = "type II error by correlations")

```

## Average Estimate and SE

```{r b se by method}

d_corr_0 |> 
  group_by(method) |> 
  summarise(mean_estimate = mean(estimate),
            SD_estimate = sd(estimate),
            mean_SE = sqrt(mean(SE^2)),
            difference = SD_estimate - mean_SE) |> 
  kbl(caption = "b_x = 0")

d_corr_05 |> 
  group_by(method) |> 
  summarise(mean_estimate = mean(estimate),
            SD_estimate = sd(estimate),
            mean_SE = sqrt(mean(SE^2)),
            difference = SD_estimate - mean_SE) |> 
  kbl(caption = "b_x = 0.5")

```

## Sampling Distributions

```{r combined hist}

d_corr_0 |> 
  ggplot(aes(x = estimate, color = method)) +
  geom_density(alpha = 0.5) +
  scale_x_continuous(limits = c(-0.5, 0.5), breaks = seq(-0.5, 0.5, by = 0.5)) +
  scale_color_manual(values = c("dodgerblue", "deeppink", "chartreuse3", "mediumpurple2", "darkorange" )) +
  labs(title = "Sampling Distribution for b_x = 0")

d_corr_05 |> 
  ggplot(aes(x = estimate, color = method)) +
  geom_density(alpha = 0.5) +
  scale_x_continuous(limits = c(0, 1), breaks = seq(0, 1, by = 0.5)) +
  scale_color_manual(values = c("dodgerblue", "deeppink", "chartreuse3", "mediumpurple2", "darkorange" )) +
  labs(title = "Sampling Distribution for b_x = 0.5")

```

